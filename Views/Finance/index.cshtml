@model IEnumerable<kfrpj.Models.rooms.rooms_list>
@{
    ViewData["Title"] = "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πà‡∏≤";
}

<div class="container-fluid py-4">
    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h2 class="mb-1">üí∞ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</h2>
                    <p class="text-muted mb-0">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô <span id="currentMonthYear"></span></p>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-success btn-lg position-relative" id="createMissionBtn">
                        <i class="bi bi-list-check me-2"></i>Mission ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="missionBadge">0</span>
                    </button>
                    <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#roomChargeModal">
                        <i class="bi bi-house me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á
                    </button>
                </div>
            </div>
            
            <!-- ‡πÅ‡∏ñ‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô -->
            <div class="progress-container mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</small>
                    <small class="text-muted">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö: <span id="collectionRate">0%</span></small>
                </div>
                <div class="progress" style="height: 10px;">
                    <div class="progress-bar bg-success" role="progressbar" id="collectionProgress" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card bg-primary text-white h-100 stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">üíµ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h6>
                            <h3 class="mb-1" id="totalIncome">‡∏ø0</h3>
                            <small class="growth-indicator" id="incomeGrowth">+0%</small>
                        </div>
                        <i class="bi bi-cash-stack fs-1 opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-success text-white h-100 stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß</h6>
                            <h3 class="mb-1" id="totalCollected">‡∏ø0</h3>
                            <small id="collectedPercentage">0% ‡∏Ç‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</small>
                        </div>
                        <i class="bi bi-wallet2 fs-1 opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-warning text-white h-100 stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">‚è≥ ‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</h6>
                            <h3 class="mb-1" id="totalPending">‡∏ø0</h3>
                            <small id="pendingPercentage">0% ‡∏Ç‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</small>
                        </div>
                        <i class="bi bi-exclamation-triangle fs-1 opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-info text-white h-100 stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">üè† ‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö</h6>
                            <h3 class="mb-1" id="pendingRoomsCount">0</h3>
                            <small id="averageAmount">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ‡∏ø0/‡∏´‡πâ‡∏≠‡∏á</small>
                        </div>
                        <i class="bi bi-house-door fs-1 opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ -->
    <div class="card mb-4 tool-section">
        <div class="card-header bg-light">
            <h6 class="mb-0">üõ†Ô∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h6>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <button class="btn btn-info w-100 tool-btn" id="generateMonthlyChargesBtn">
                        <i class="bi bi-calendar-plus mb-2 d-block fs-4"></i>
                        <div class="fw-bold">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
                        <small class="text-muted">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</small>
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-secondary w-100 tool-btn" id="printMissionBtn">
                        <i class="bi bi-printer mb-2 d-block fs-4"></i>
                        <div class="fw-bold">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</div>
                        <small class="text-muted">‡∏û‡∏¥‡∏°‡∏û‡πå Mission ‡∏≠‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©</small>
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-success w-100 tool-btn" id="markAllPaidBtn">
                        <i class="bi bi-check-circle-fill mb-2 d-block fs-4"></i>
                        <div class="fw-bold">‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</div>
                        <small class="text-muted">‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</small>
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary w-100 tool-btn" id="overdueReportBtn">
                        <i class="bi bi-exclamation-triangle mb-2 d-block fs-4"></i>
                        <div class="fw-bold">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</div>
                        <small class="text-muted">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h6 class="mb-0">
                        <i class="bi bi-list-check me-2"></i>Mission View - ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á
                    </h6>
                </div>
                <div class="col-md-6">
                    <div class="d-flex justify-content-end align-items-center gap-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="hideCompletedRooms">
                            <label class="form-check-label" for="hideCompletedRooms">
                                ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß
                            </label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="autoRefresh">
                            <label class="form-check-label" for="autoRefresh">
                                ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                            </label>
                        </div>
                        <button class="btn btn-outline-info" id="refreshDataBtn">
                            <i class="bi bi-arrow-clockwise me-1"></i>‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mission View - ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á -->
    <div class="card mission-view-card" id="missionViewCard">
        <div class="card-header bg-gradient-success text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list-check me-2"></i>Mission ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
                </h5>
                <div class="d-flex align-items-center gap-3">
                    <span class="badge bg-light text-dark">
                        <i class="bi bi-calendar3 me-1"></i><span id="missionDate"></span>
                    </span>
                    <div class="dropdown">
                        <button class="btn btn-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-funnel"></i> ‡∏Å‡∏£‡∏≠‡∏á
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item filter-option" href="#" data-filter="all">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a></li>
                            <li><a class="dropdown-item filter-option" href="#" data-filter="unpaid">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢</a></li>
                            <li><a class="dropdown-item filter-option" href="#" data-filter="partial">‡∏à‡πà‡∏≤‡∏¢‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô</a></li>
                            <li><a class="dropdown-item filter-option" href="#" data-filter="overdue">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table id="missionTable" class="table table-hover mb-0 display nowrap" style="width:100%">
                    <thead class="table-dark sticky-top">
                        <tr>
                            <th class="text-center" style="width: 5%">
                                <input type="checkbox" class="form-check-input" id="selectAllRooms" title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">
                            </th>
                            <th class="text-center" style="width: 8%">‡∏´‡πâ‡∏≠‡∏á</th>
                            <th style="width: 15%">‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤</th>
                            <th class="text-center" style="width: 12%">‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á</th>
                            <th class="text-center" style="width: 10%">‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥</th>
                            <th class="text-center" style="width: 10%">‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü</th> 
                            <th class="text-center" style="width: 12%">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th>
                            <th class="text-center" style="width: 10%">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</th>
                            <th class="text-center" style="width: 15%">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="missionTableBody">
                        <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏î‡πâ‡∏ß‡∏¢ JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <small class="text-muted">
                        ‡πÅ‡∏™‡∏î‡∏á <span id="visibleRooms">0</span> ‡∏à‡∏≤‡∏Å <span id="totalRooms">0</span> ‡∏´‡πâ‡∏≠‡∏á
                    </small>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-sm btn-outline-primary" id="exportMissionBtn">
                        <i class="bi bi-download me-1"></i>‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                    <button class="btn btn-sm btn-success" id="bulkCollectBtn" disabled>
                        <i class="bi bi-check-circle me-1"></i>‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    </button>
                </div>
            </div>
        </div>
    </div>


</div>

<!-- Modals -->
<!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡πâ‡∏≠‡∏á -->
<div class="modal fade" id="roomDetailModal" tabindex="-1" aria-labelledby="roomDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="roomDetailModalLabel">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="roomDetailContent">
                <!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏î‡πâ‡∏ß‡∏¢ JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
                <button type="button" class="btn btn-primary" id="printRoomDetailBtn">
                    <i class="bi bi-printer me-1"></i>‡∏û‡∏¥‡∏°‡∏û‡πå
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥ -->
<div class="modal fade" id="waterBillModal" tabindex="-1" aria-labelledby="waterBillModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="waterBillModalLabel">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="waterBillForm">
                <div class="modal-body">
                    <input type="hidden" id="water_bill_id" name="water_bill_id">
                    <input type="hidden" id="water_room_id" name="room_id">
                    <input type="hidden" id="water_units" name="water_units">
                    <div class="mb-3">
                        <label class="form-label">‡∏´‡πâ‡∏≠‡∏á</label>
                        <input type="text" class="form-control" id="water_room_name" readonly>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="water_people_count" class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="water_people_count" name="people_count" min="1" required>
                            <div class="form-text">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á</div>
                        </div>
                        <div class="col-md-6">
                            <label for="water_bill_amount" class="form-label">‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥ (‡∏ö‡∏≤‡∏ó)</label>
                            <input type="number" class="form-control" id="water_bill_amount" name="water_bill" readonly>
                            <div class="form-text">‡∏≠‡∏±‡∏ï‡∏£‡∏≤ <span id="waterRateDisplay">150</span> ‡∏ö‡∏≤‡∏ó/‡∏Ñ‡∏ô</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="water_bill_notes" class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <textarea class="form-control" id="water_bill_notes" name="notes" rows="2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏°‡∏µ‡∏Ñ‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°, ‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-1"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü -->
<div class="modal fade" id="electricBillModal" tabindex="-1" aria-labelledby="electricBillModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="electricBillModalLabel">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="electricBillForm">
                <div class="modal-body">
                    <input type="hidden" id="electric_bill_id" name="electric_bill_id">
                    <input type="hidden" id="electric_room_id" name="room_id">
                    <input type="hidden" id="meter_date" name="meter_date">
                    <div class="mb-3">
                        <label class="form-label">‡∏´‡πâ‡∏≠‡∏á</label>
                        <input type="text" class="form-control" id="electric_room_name" readonly>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="electric_old_meter" class="form-label">‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏Å‡πà‡∏≤ <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="electric_old_meter" name="old_meter" required>
                            <div class="form-text">‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô</div>
                        </div>
                        <div class="col-md-6">
                            <label for="electric_new_meter" class="form-label">‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="electric_new_meter" name="new_meter" required>
                            <div class="form-text">‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="electric_units" class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
                            <input type="number" class="form-control" id="electric_units" name="electric_units" readonly>
                            <div class="form-text">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
                        </div>
                        <div class="col-md-6">
                            <label for="electric_bill_amount" class="form-label">‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü (‡∏ö‡∏≤‡∏ó)</label>
                            <input type="number" class="form-control" id="electric_bill_amount" name="electric_bill" readonly>
                            <div class="form-text">‡∏≠‡∏±‡∏ï‡∏£‡∏≤ <span id="electricRateDisplay">5</span> ‡∏ö‡∏≤‡∏ó/‡∏´‡∏ô‡πà‡∏ß‡∏¢</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="electric_bill_notes" class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <textarea class="form-control" id="electric_bill_notes" name="notes" rows="2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏™‡∏µ‡∏¢, ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-1"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á -->
<div class="modal fade" id="roomChargeModal" tabindex="-1" aria-labelledby="roomChargeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="roomChargeModalLabel">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="roomChargeForm">
                <div class="modal-body">
                    <input type="hidden" id="room_charge_id" name="room_charge_id">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="room_charge_room_id" class="form-label">‡∏´‡πâ‡∏≠‡∏á <span class="text-danger">*</span></label>
                            <select class="form-select" id="room_charge_room_id" name="room_id" required>
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="charge_month" class="form-label">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô <span class="text-danger">*</span></label>
                            <input type="month" class="form-control" id="charge_month" name="charge_month" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="room_price" class="form-label">‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á (‡∏ö‡∏≤‡∏ó) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="room_price" name="room_price" required>
                            <div class="form-text">‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                        </div>
                        <div class="col-md-6">
                            <label for="due_date" class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="due_date" name="due_date" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="room_charge_notes" class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <textarea class="form-control" id="room_charge_notes" name="notes" rows="2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©, ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-1"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤ -->
<div class="modal fade" id="tenantModal" tabindex="-1" aria-labelledby="tenantModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="tenantModalLabel">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="tenant_room_id" name="tenant_room_id">
                
                <div id="current_tenant_info" class="mb-4">
                    <div class="alert alert-info" id="no_tenant_alert">
                        <i class="bi bi-info-circle me-2"></i>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ
                    </div>
                    <div id="tenant_details" style="display: none;">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="bi bi-person-circle me-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h6>
                            </div>
                            <div class="card-body">
                                <p class="mb-2"><strong>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</strong> <span id="current_tenant_name"></span></p>
                                <p class="mb-2"><strong>‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</strong> <span id="current_tenant_email"></span></p>
                                <p class="mb-2"><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</strong> <span id="current_tenant_phone"></span></p>
                                <p class="mb-0"><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤:</strong> <span id="current_tenant_start_date"></span></p>
                                <p class="mb-0"><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤:</strong> <span id="current_tenant_end_date"></span></p>
                            </div>
                        </div>
                        <div class="text-end mt-2">
                            <button class="btn btn-danger" id="remove_tenant_btn">
                                <i class="bi bi-person-x-fill me-2"></i>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="update_tenant_section">
                    <h6><i class="bi bi-person-plus-fill me-2"></i>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà</h6>
                    
                    <div class="mb-3">
                        <label for="tenant_select" class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                        <select class="form-select" id="tenant_select">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤ --</option>
                        </select>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="tenant_start_date" class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤</label>
                            <input type="date" class="form-control" id="tenant_start_date">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="tenant_end_date" class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤</label>
                            <input type="date" class="form-control" id="tenant_end_date">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
                <button type="button" class="btn btn-primary" id="save_tenant_btn">
                    <i class="bi bi-save me-1"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á CSS */
.stat-card {
    transition: transform 0.2s ease-in-out;
    border: none;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
}

.tool-btn {
    height: 120px;
    text-align: center;
    border-radius: 10px;
    transition: all 0.3s ease;
}

.tool-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

.mission-view-card {
    border: none;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
}

.bg-gradient-success {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}

.growth-indicator {
    font-weight: bold;
}

.progress-container {
    background: rgba(255, 255, 255, 0.1);
    padding: 15px;
    border-radius: 10px;
    backdrop-filter: blur(10px);
}

.room-row {
    transition: all 0.3s ease;
}

.room-row:hover {
    background-color: rgba(0, 123, 255, 0.05);
}

.priority-high {
    border-left: 4px solid #dc3545;
    background-color: rgba(220, 53, 69, 0.05);
}

.priority-medium {
    border-left: 4px solid #ffc107;
    background-color: rgba(255, 193, 7, 0.05);
}

.priority-normal {
    border-left: 4px solid #28a745;
    background-color: rgba(40, 167, 69, 0.05);
}

.bill-amount {
    font-weight: bold;
    font-size: 1.1em;
}

.amount-paid {
    color: #28a745;
}

.amount-unpaid {
    color: #dc3545;
}

.amount-partial {
    color: #ffc107;
}

.sticky-top {
    position: sticky;
    top: 0;
    z-index: 1020;
}

.table th {
    border-top: none;
    font-weight: 600;
}

.progress-mini {
    height: 8px;
    border-radius: 4px;
}

@@media (max-width: 768px) {
    .tool-btn {
        height: 80px;
        font-size: 0.9em;
    }
    
    .stat-card h3 {
        font-size: 1.5rem;
    }
}

/* Dark mode support */
[data-bs-theme="dark"] .tool-section {
    background-color: #2b3035;
    border-color: #373b3e;
}

[data-bs-theme="dark"] .progress-container {
    background: rgba(0, 0, 0, 0.2);
}

[data-bs-theme="dark"] .priority-high {
    background-color: rgba(220, 53, 69, 0.1);
}

[data-bs-theme="dark"] .priority-medium {
    background-color: rgba(255, 193, 7, 0.1);
}

[data-bs-theme="dark"] .priority-normal {
    background-color: rgba(40, 167, 69, 0.1);
}

/* Loading states */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

.skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
}

@@keyframes loading {
    0% {
        background-position: 200% 0;
    }
    100% {
        background-position: -200% 0;
    }
}

/* Notification styles */
.notification-badge {
    animation: pulse 2s infinite;
}

@@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
    }
    70% {
        box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
    }
}
</style>

@section Scripts {
    <script>
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global
        let missionData = [];
        let currentFilter = 'all';
        let selectedRooms = new Set();
        let autoRefreshInterval = null;
        let rates = { waterRate: 15, electricRate: 5 };
        let missionTable; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á DataTable

        $(document).ready(function () {
            initializePage();
            loadInitialData();
            setupEventListeners();
            setupAutoRefresh();
        });

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        function initializePage() {
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            const now = moment();
            $('#currentMonthYear').text(now.format('MMMM YYYY'));
            $('#missionDate').text(now.format('DD/MM/YYYY'));
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
            $('#meter_date, #electric_meter_date').val(now.format('YYYY-MM-DD'));
            $('#charge_month').val(now.format('YYYY-MM'));
            
            // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á
            loadRoomOptions();
            
            // ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢
            loadRates();
        }

        function loadInitialData() {
            updateStatistics();
            loadMissionData();
        }

        function loadMissionData() {
            console.log('‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Mission...');
            showLoading('#missionTableBody');
            
            $.ajax({
                url: '/Finance/GetMissionData',
                type: 'GET',
                timeout: 30000, // 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                success: function (response) {
                    console.log('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö response:', response);
                    if (response && response.success) {
                        missionData = response.rooms || [];
                        console.log('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Mission:', missionData.length, '‡∏´‡πâ‡∏≠‡∏á');
                        renderMissionTable();
                        updateMissionStats();
                    } else {
                        console.error('Response ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', response);
                        showError(response?.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Mission ‡πÑ‡∏î‡πâ');
                        $('#missionTableBody').html('<tr><td colspan="9" class="text-center text-danger py-4">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</td></tr>');
                    }
                },
                error: function (xhr, status, error) {
                    console.error('AJAX Error:', { xhr, status, error });
                    console.error('Response Text:', xhr.responseText);
                    
                    let errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
                    if (xhr.status === 404) {
                        errorMessage = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (404)';
                    } else if (xhr.status === 500) {
                        errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå (500)';
                    } else if (status === 'timeout') {
                        errorMessage = '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
                    }
                    
                    showError(errorMessage);
                    $('#missionTableBody').html('<tr><td colspan="9" class="text-center text-danger py-4">' + errorMessage + '</td></tr>');
                },
                complete: function () {
                    hideLoading('#missionTableBody');
                }
            });
        }

        function renderMissionTable() {
            console.log('‡πÄ‡∏£‡∏¥‡πà‡∏° render ‡∏ï‡∏≤‡∏£‡∏≤‡∏á Mission, missionData:', missionData);
            
            if (!missionData || !Array.isArray(missionData)) {
                console.error('missionData ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà array ‡∏´‡∏£‡∏∑‡∏≠ undefined:', missionData);
                $('#missionTableBody').html('<tr><td colspan="9" class="text-center text-warning py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>');
                updateTableStats(0, 0);
                return;
            }

            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ DataTable ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô
            if ($.fn.DataTable.isDataTable('#missionTable')) {
                if (missionTable) {
                    missionTable.destroy();
                } else {
                    // ‡∏ñ‡πâ‡∏≤ missionTable ‡πÄ‡∏õ‡πá‡∏ô undefined ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢ DataTable ‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡∏¥‡∏ò‡∏µ‡∏≠‡∏∑‡πà‡∏ô
                    $('#missionTable').DataTable().destroy();
                }
                $('#missionTableBody').empty();
            }

            let tableData = [];
            
            missionData.forEach((room, index) => {
                try {
                    const rowClass = getPriorityClass(room);
                    const progressWidth = room.paymentProgress || 0;
                    const progressClass = getProgressClass(progressWidth);
                    
                    // ‡πÄ‡∏û‡∏¥‡πà‡∏° log ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á
                    console.log('Room data:', room.roomName, 'Room charge:', room.roomCharge);
                    
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ñ‡∏ß
                    const rowData = [
                        // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå checkbox
                        `<input type="checkbox" class="form-check-input room-checkbox" value="${room.roomId}">`,
                        
                        // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏´‡πâ‡∏≠‡∏á
                        `<span class="fw-bold text-primary fs-5">${room.roomName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>`,
                        
                        // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤
                        `<div class="d-flex align-items-center">
                            <i class="bi bi-person-circle me-2 text-muted"></i>
                            ${room.tenantName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                        </div>`,
                        
                        // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ room.roomCharge ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á amount
                        `<div class="d-flex align-items-center justify-content-center gap-1">
                            <span class="bill-amount ${room.roomCharge?.isPaid ? 'amount-paid' : 'amount-unpaid'}">
                                ‡∏ø${(room.roomCharge && room.roomCharge.amount ? room.roomCharge.amount : 0).toLocaleString()}
                            </span>
                            ${(room.roomCharge && room.roomCharge.amount > 0 && !room.roomCharge.isPaid) ? 
                                `<button class="btn btn-sm btn-outline-success" onclick="editRoomCharge(${room.roomId}, '${room.roomName}', ${room.roomCharge.id})" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á">
                                    <i class="bi bi-pencil"></i>
                                </button>` : ''
                            }
                            ${(!room.roomCharge || !room.roomCharge.amount || room.roomCharge.amount <= 0) ? 
                                `<button class="btn btn-sm btn-success" onclick="manualCreateRoomCharge(${room.roomId}, '${room.roomName}')" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á">
                                    <i class="bi bi-plus"></i>
                                </button>` : ''
                            }
                        </div>
                        ${room.roomCharge?.isPaid ? '<br><i class="bi bi-check-circle text-success"></i>' : ''}`,
                        
                        // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥
                        `<div class="d-flex align-items-center justify-content-center gap-1">
                            <span class="bill-amount ${room.waterBill?.isPaid ? 'amount-paid' : 'amount-unpaid'}">
                                ‡∏ø${(room.waterBill?.amount || 0).toLocaleString()}
                            </span>
                            ${(room.waterBill?.amount || 0) > 0 && !room.waterBill?.isPaid ? 
                                `<button class="btn btn-sm btn-outline-primary" onclick="editWaterBill(${room.roomId}, '${room.roomName}')" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥">
                                    <i class="bi bi-pencil"></i>
                                </button>` : ''
                            }
                            ${(room.waterBill?.amount || 0) === 0 ? 
                                `<button class="btn btn-sm btn-primary" onclick="addWaterBill(${room.roomId}, '${room.roomName}')" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥">
                                    <i class="bi bi-plus"></i>
                                </button>` : ''
                            }
                        </div>
                        ${(room.waterBill?.amount || 0) > 0 ? `<br><small class="text-muted">${room.waterBill?.units || 0} ‡∏Ñ‡∏ô</small>` : ''}
                        ${room.waterBill?.isPaid ? '<br><i class="bi bi-check-circle text-success"></i>' : ''}`,
                        
                        // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü
                        `<div class="d-flex align-items-center justify-content-center gap-1">
                            <span class="bill-amount ${room.electricBill?.isPaid ? 'amount-paid' : 'amount-unpaid'}">
                                ‡∏ø${(room.electricBill?.amount || 0).toLocaleString()}
                            </span>
                            ${(room.electricBill?.amount || 0) > 0 && !room.electricBill?.isPaid ? 
                                `<button class="btn btn-sm btn-outline-warning" onclick="editElectricBill(${room.roomId}, '${room.roomName}')" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü">
                                    <i class="bi bi-pencil"></i>
                                </button>` : ''
                            }
                            ${(room.electricBill?.amount || 0) === 0 ? 
                                `<button class="btn btn-sm btn-warning" onclick="addElectricBill(${room.roomId}, '${room.roomName}')" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü">
                                    <i class="bi bi-plus"></i>
                                </button>` : ''
                            }
                        </div>
                        ${(room.electricBill?.amount || 0) > 0 ? `<br><small class="text-muted">${room.electricBill?.units || 0} ‡∏´‡∏ô‡πà‡∏ß‡∏¢</small>` : ''}
                        ${room.electricBill?.isPaid ? '<br><i class="bi bi-check-circle text-success"></i>' : ''}`,
                        
                        // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        `<span class="bill-amount fw-bold text-primary fs-5">
                            ‡∏ø${(room.totalAmount || 0).toLocaleString()}
                        </span>
                        ${(room.pendingAmount || 0) > 0 ? `<br><small class="text-danger">‡∏Ñ‡πâ‡∏≤‡∏á ‡∏ø${(room.pendingAmount || 0).toLocaleString()}</small>` : ''}`,
                        
                        // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤
                        `<div class="progress progress-mini mb-1" style="height: 8px;">
                            <div class="progress-bar ${progressClass}" role="progressbar" 
                                style="width: ${progressWidth}%" aria-valuenow="${progressWidth}" 
                                aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <small class="text-muted">${progressWidth}%</small>`,
                        
                        // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
                        `<div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-info" onclick="showRoomDetail(${room.roomId})" title="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">
                                <i class="bi bi-eye"></i>
                            </button>
                            ${!room.isFullyPaid ? `
                                <button class="btn btn-outline-success" onclick="markRoomAsPaid(${room.roomId})" title="‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏£‡∏ö">
                                    <i class="bi bi-check-circle"></i>
                                </button>
                            ` : ''}
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-secondary dropdown-toggle dropdown-toggle-split" 
                                        data-bs-toggle="dropdown" aria-expanded="false" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°">
                                    <i class="bi bi-three-dots"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="showPaymentHistory(${room.roomId})">
                                        <i class="bi bi-clock-history me-2"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="printRoomReceipt(${room.roomId})">
                                        <i class="bi bi-receipt me-2"></i>‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="manageTenant(${room.roomId}, '${room.roomName}')">
                                        <i class="bi bi-person-fill me-2"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤
                                    </a></li>
                                </ul>
                            </div>
                        </div>`
                    ];
                    
                    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ñ‡∏ß‡πÑ‡∏õ‡∏¢‡∏±‡∏á tableData
                    tableData.push(rowData);
                    
                } catch (roomError) {
                    console.error('Error rendering room:', room, roomError);
                }
            });
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á DataTable
            missionTable = $('#missionTable').DataTable({
                data: tableData,
                columns: [
                    { title: '<input type="checkbox" id="dt-select-all">' },
                    { title: '‡∏´‡πâ‡∏≠‡∏á' },
                    { title: '‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤' },
                    { title: '‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á' },
                    { title: '‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥' },
                    { title: '‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü' },
                    { title: '‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' },
                    { title: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤' },
                    { title: '‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£' }
                ],
                language: {
                    "search": "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:",
                    "lengthMenu": "‡πÅ‡∏™‡∏î‡∏á _MENU_ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",
                    "zeroRecords": "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
                    "info": "‡πÅ‡∏™‡∏î‡∏á _START_ ‡∏ñ‡∏∂‡∏á _END_ ‡∏à‡∏≤‡∏Å _TOTAL_ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",
                    "infoEmpty": "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏î‡πâ",
                    "infoFiltered": "(‡∏Å‡∏£‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î _MAX_ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)",
                    "paginate": {
                        "first": "‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å",
                        "last": "‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢",
                        "next": "‡∏ñ‡∏±‡∏î‡πÑ‡∏õ",
                        "previous": "‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤"
                    }
                },
                responsive: true,
                order: [[1, 'asc']], // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á
                dom: 'Bfrtip',
                buttons: [
                    {
                        extend: 'copy',
                        text: '<i class="bi bi-clipboard"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å',
                        className: 'btn btn-outline-primary btn-sm'
                    },
                    {
                        extend: 'excel',
                        text: '<i class="bi bi-file-earmark-excel"></i> Excel',
                        className: 'btn btn-outline-success btn-sm'
                    },
                    {
                        extend: 'pdf',
                        text: '<i class="bi bi-file-earmark-pdf"></i> PDF',
                        className: 'btn btn-outline-danger btn-sm'
                    },
                    {
                        extend: 'print',
                        text: '<i class="bi bi-printer"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå',
                        className: 'btn btn-outline-info btn-sm'
                    }
                ],
                columnDefs: [
                    { 
                        targets: 0, 
                        orderable: false,
                        className: 'select-checkbox text-center',
                        width: '5%'
                    },
                    { targets: 1, width: '8%' },
                    { targets: 2, width: '15%' },
                    { targets: 3, width: '12%' },
                    { targets: 4, width: '10%' },
                    { targets: 5, width: '10%' },
                    { targets: 6, width: '12%' },
                    { targets: 7, width: '10%' },
                    { 
                        targets: 8, 
                        orderable: false,
                        width: '15%'
                    }
                ],
                drawCallback: function() {
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    updateSelectedRooms();
                    
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                    updateTableStats(missionTable.page.info().recordsDisplay, missionTable.page.info().recordsTotal);
                }
            });
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö checkbox ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            $('#dt-select-all').on('click', function() {
                $('.room-checkbox').prop('checked', this.checked);
                updateSelectedRooms();
            });
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö checkbox ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏ñ‡∏ß
            $('#missionTable tbody').on('change', '.room-checkbox', function() {
                updateSelectedRooms();
            });

            console.log('Render table ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠
        function getPriorityClass(room) {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ room.roomCharge ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á daysOverdue
            if (!room.roomCharge) {
                return 'priority-high'; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏π‡∏á
            }

            if (room.roomCharge.daysOverdue > 7) return 'priority-high';
            if (room.roomCharge.daysOverdue > 0 || room.isPartiallyPaid) return 'priority-medium';
            if (room.isFullyPaid) return 'priority-normal';
            return '';
        }

        function getProgressClass(progress) {
            if (progress >= 100) return 'bg-success';
            if (progress >= 50) return 'bg-warning';
            return 'bg-danger';
        }

        function applyCurrentFilter(data) {
            let filtered = data;

            // ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
            switch (currentFilter) {
                case 'unpaid':
                    filtered = filtered.filter(room => !room.isFullyPaid && !room.isPartiallyPaid);
                    break;
                case 'partial':
                    filtered = filtered.filter(room => room.isPartiallyPaid);
                    break;
                case 'overdue':
                    filtered = filtered.filter(room => room.roomCharge.daysOverdue > 0);
                    break;
            }

            // ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏£‡∏ö
            if ($('#hideCompletedRooms').is(':checked')) {
                filtered = filtered.filter(room => !room.isFullyPaid);
            }

            return filtered;
        }

        function applyFilter() {
            renderMissionTable();
        }

        function updateSelectedRooms() {
            selectedRooms.clear();
            $('.room-checkbox:checked').each(function () {
                selectedRooms.add(parseInt($(this).val()));
            });

            $('#bulkCollectBtn').prop('disabled', selectedRooms.size === 0);
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ select all
            const totalCheckboxes = $('.room-checkbox').length;
            const checkedCheckboxes = $('.room-checkbox:checked').length;
            
            $('#selectAllRooms').prop('checked', checkedCheckboxes === totalCheckboxes && totalCheckboxes > 0);
            $('#selectAllRooms').prop('indeterminate', checkedCheckboxes > 0 && checkedCheckboxes < totalCheckboxes);
        }

        function updateTableStats(visible, total) {
            $('#visibleRooms').text(visible);
            $('#totalRooms').text(total);
        }

        function updateMissionStats() {
            const unpaidCount = missionData.filter(room => !room.isFullyPaid).length;
            $('#missionBadge').text(unpaidCount);
            
            if (unpaidCount > 0) {
                $('#missionBadge').addClass('notification-badge');
            } else {
                $('#missionBadge').removeClass('notification-badge');
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        function calculateWaterBill() {
            const oldMeter = parseInt($('#old_meter').val()) || 0;
            const newMeter = parseInt($('#new_meter').val()) || 0;
            const units = Math.max(0, newMeter - oldMeter);
            const bill = units * rates.waterRate;

            $('#water_units').val(units);
            $('#water_bill').val(bill);
        }

        function calculateElectricBill() {
            const oldMeter = parseInt($('#electric_old_meter').val()) || 0;
            const newMeter = parseInt($('#electric_new_meter').val()) || 0;
            const units = Math.max(0, newMeter - oldMeter);
            const electricRate = rates.electricRate || 5;
            const bill = units * electricRate;

            $('#electric_units').val(units);
            $('#electric_bill_amount').val(bill);
        }

        function handleWaterMeterSubmit(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const waterId = $('#water_meter_id').val();
            const isEdit = waterId && waterId.trim() !== '';
            
            const url = isEdit ? `/Finance/UpdateWaterMeter/${waterId}` : '/Finance/CreateWaterMeter';
            
            $.ajax({
                url: url,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    if (response.success) {
                        $('#waterMeterModal').modal('hide');
                        refreshAllData();
                        showSuccess(isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                    } else {
                        showError(response.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
                    }
                },
                error: function () {
                    showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                }
            });
        }

        function handleElectricMeterSubmit(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const electricId = $('#electric_meter_id').val();
            const isEdit = electricId && electricId.trim() !== '';
            
            const url = isEdit ? `/Finance/UpdateElectricMeter/${electricId}` : '/Finance/CreateElectricMeter';
            
            $.ajax({
                url: url,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    if (response.success) {
                        $('#electricMeterModal').modal('hide');
                        refreshAllData();
                        showSuccess(isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                    } else {
                        showError(response.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
                    }
                },
                error: function () {
                    showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                }
            });
        }

        function handleRoomChargeSubmit(e) {
            e.preventDefault();
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ room_id ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const roomId = $('#room_charge_room_id').val();
            if (!roomId) {
                showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á');
                return;
            }
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á FormData ‡∏à‡∏≤‡∏Å form
            const formData = new FormData(this);
            
            // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á controller
            const roomChargeId = $('#room_charge_id').val();
            const isEdit = roomChargeId && roomChargeId.trim() !== '';
            const url = isEdit ? `/Finance/UpdateRoomCharge/${roomChargeId}` : '/Finance/CreateRoomCharge';
            
            $.ajax({
                url: url,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        $('#roomChargeModal').modal('hide');
                        safeRefreshData(); // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô safeRefreshData ‡πÅ‡∏ó‡∏ô refreshAllData
                        showSuccess(isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                    } else {
                        showError(response.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
                    }
                },
                error: function(xhr) {
                    showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + (xhr.responseJSON?.message || xhr.statusText));
                }
            });
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≤‡∏á‡πÜ
        function refreshAllData() {
            updateStatistics();
            loadMissionData();
        }
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Å‡∏ß‡πà‡∏≤
        function safeRefreshData() {
            try {
                updateStatistics();
                
                // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏Å‡πà‡∏≠‡∏ô
                if ($('#missionTableBody').hasClass('loading')) {
                    console.log('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...');
                    setTimeout(safeRefreshData, 1000);
                    return;
                }
                
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ DataTable ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
                if ($.fn.DataTable.isDataTable('#missionTable')) {
                    try {
                        $('#missionTable').DataTable().destroy();
                    } catch (e) {
                        console.warn('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢ DataTable ‡πÄ‡∏î‡∏¥‡∏°:', e);
                    }
                    $('#missionTableBody').empty();
                }
                
                // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ missionTable
                missionTable = null;
                
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                loadMissionData();
            } catch (e) {
                console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:', e);
                showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
            }
        }

        function generateMonthlyCharges() {
            Swal.fire({
                title: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
                text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏¢',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                                    if (result.isConfirmed) {
                        $.post('/Finance/GenerateMonthlyCharges', function (response) {
                            if (response.success) {
                                safeRefreshData(); // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô safeRefreshData ‡πÅ‡∏ó‡∏ô refreshAllData
                                Swal.fire({
                                    title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                                    html: `${response.message}<br>
                                          <strong>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà:</strong> ${response.createdCount} ‡∏´‡πâ‡∏≠‡∏á<br>
                                          <strong>‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß:</strong> ${response.skippedCount} ‡∏´‡πâ‡∏≠‡∏á`,
                                    icon: 'success'
                                });
                            } else {
                                showError(response.message);
                            }
                        }).fail(() => showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ'));
                    }
            });
        }

        function markRoomAsPaid(roomId) {
            const room = missionData.find(r => r.roomId === roomId);
            if (!room) return;

            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô',
                html: `<div class="text-center">
                    <h5>‡∏´‡πâ‡∏≠‡∏á ${room.roomName}</h5>
                    <p class="mb-2">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö: <strong class="text-primary">‡∏ø${room.pendingAmount.toLocaleString()}</strong></p>
                    <div class="alert alert-info">
                        <small>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</small>
                    </div>
                </div>`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('/Finance/MarkRoomAsPaid', { roomId: roomId }, function (response) {
                        if (response.success) {
                            safeRefreshData(); // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô safeRefreshData ‡πÅ‡∏ó‡∏ô refreshAllData
                            showSuccess(`‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡πâ‡∏≠‡∏á ${room.roomName} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
                        } else {
                            showError(response.message);
                        }
                    }).fail(() => showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ'));
                }
            });
        }

        function bulkCollectPayment() {
            if (selectedRooms.size === 0) return;

            const selectedRoomNames = Array.from(selectedRooms).map(id => {
                const room = missionData.find(r => r.roomId === id);
                return room ? room.roomName : '';
            }).filter(name => name).join(', ');

            Swal.fire({
                title: '‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏´‡πâ‡∏≠‡∏á',
                html: `<div class="text-center">
                    <p>‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
                    <div class="alert alert-info">
                        <strong>‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</strong><br>${selectedRoomNames}
                    </div>
                    <p class="text-muted"><small>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${selectedRooms.size} ‡∏´‡πâ‡∏≠‡∏á</small></p>
                </div>`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/Finance/BulkMarkAsPaid',
                        type: 'POST',
                        data: JSON.stringify(Array.from(selectedRooms)),
                        contentType: 'application/json',
                        success: function (response) {
                            if (response.success) {
                                safeRefreshData(); // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô safeRefreshData ‡πÅ‡∏ó‡∏ô refreshAllData
                                selectedRooms.clear();
                                updateSelectedRooms();
                                showSuccess(`‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ${response.successCount}/${response.totalCount} ‡∏´‡πâ‡∏≠‡∏á`);
                            } else {
                                showError(response.message);
                            }
                        },
                        error: function () {
                            showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ');
                        }
                    });
                }
            });
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô UI ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        function toggleViewMode() {
            const isMissionView = $('#missionView').is(':checked');
            $('#missionViewCard').toggle(isMissionView);
            $('#detailViewCard').toggle(!isMissionView);
            
            if (!isMissionView && !$.fn.DataTable.isDataTable('#waterMeterTable')) {
                initializeDetailTables();
            }
        }

        function showLoading(selector) {
            $(selector).html('<tr><td colspan="9" class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span></div></td></tr>');
        }

        function hideLoading(selector) {
            // Loading will be replaced by actual content
        }

        function showSuccess(message) {
            Swal.fire({
                title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                text: message,
                icon: 'success',
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
        }

        function showError(message) {
            Swal.fire({
                title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
                text: message,
                icon: 'error',
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 5000,
                timerProgressBar: true
            });
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ
        function setupAutoRefresh() {
            // Auto refresh every 5 minutes if enabled
        }

        function startAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            autoRefreshInterval = setInterval(refreshAllData, 300000); // 5 minutes
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ implement
        function createMission() {
            $('#createMissionBtn').addClass('active');
            setTimeout(() => {
                $('#createMissionBtn').removeClass('active');
            }, 500);
            
            // ‡πÄ‡∏ô‡πâ‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà Mission Table
            $('html, body').animate({
                scrollTop: $('#missionViewCard').offset().top - 100
            }, 800);
        }

        function printMission() {
            window.open('/Finance/PrintMissionList', '_blank');
        }

        function markAllAsPaid() {
            if (missionData.length === 0) {
                showError('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á');
                return;
            }

            const unpaidRooms = missionData.filter(room => !room.isFullyPaid);
            if (unpaidRooms.length === 0) {
                showError('‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
                return;
            }

            Swal.fire({
                title: '‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á',
                html: `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?<br>
                       <strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢:</strong> ${unpaidRooms.length} ‡∏´‡πâ‡∏≠‡∏á`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    const roomIds = unpaidRooms.map(room => room.roomId);
                    bulkCollectPaymentInternal(roomIds);
                }
            });
        }

        function showOverdueReport() {
            $.get('/Finance/GetOverdueReport', function(response) {
                if (response.success) {
                    let reportHtml = `
                        <div class="alert alert-info">
                            <h6><i class="bi bi-info-circle me-2"></i>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</h6>
                            <p class="mb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞: <strong>${response.summary.totalItems}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                            <p class="mb-1">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: <strong>‡∏ø${response.summary.totalAmount.toLocaleString()}</strong></p>
                            <p class="mb-0">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞: <strong>${response.summary.averageDaysOverdue}</strong> ‡∏ß‡∏±‡∏ô</p>
                        </div>
                    `;

                    if (response.overdueItems.length > 0) {
                        reportHtml += `
                            <div class="table-responsive">
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th>‡∏´‡πâ‡∏≠‡∏á</th>
                                            <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                                            <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                                            <th>‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î</th>
                                            <th>‡∏ß‡∏±‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;

                        response.overdueItems.forEach(item => {
                            reportHtml += `
                                <tr>
                                    <td>${item.roomName}</td>
                                    <td>${item.type}</td>
                                    <td class="text-end">‡∏ø${item.amount.toLocaleString()}</td>
                                    <td>${moment(item.dueDate).format('DD/MM/YYYY')}</td>
                                    <td><span class="badge bg-danger">${item.daysOverdue} ‡∏ß‡∏±‡∏ô</span></td>
                                </tr>
                            `;
                        });

                        reportHtml += '</tbody></table></div>';
                    } else {
                        reportHtml += '<div class="alert alert-success">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</div>';
                    }

                    Swal.fire({
                        title: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞',
                        html: reportHtml,
                        width: '800px',
                        showCloseButton: true,
                        focusConfirm: false,
                        confirmButtonText: '‡∏õ‡∏¥‡∏î'
                    });
                } else {
                    showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ');
                }
            }).fail(() => showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô'));
        }

        function exportMissionData() {
            window.location.href = '/Finance/ExportMissionData';
        }

        function bulkCollectPaymentInternal(roomIds) {
            $.ajax({
                url: '/Finance/BulkMarkAsPaid',
                type: 'POST',
                data: JSON.stringify(roomIds),
                contentType: 'application/json',
                success: function (response) {
                    if (response.success) {
                        refreshAllData();
                        showSuccess(`‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ${response.successCount}/${response.totalCount} ‡∏´‡πâ‡∏≠‡∏á`);
                    } else {
                        showError(response.message);
                    }
                },
                error: function () {
                    showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ');
                }
            });
        }

        // Global functions ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å HTML ‡πÅ‡∏•‡∏∞ DataTables
        window.showRoomDetail = function(roomId) {
            $.get('/Finance/GetRoomDetail', { roomId: roomId }, function(response) {
                if (response.success) {
                    const room = response.data.roomInfo;
                    const history = response.data.paymentHistory;
                    
                    let detailHtml = `
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6><i class="bi bi-house-door me-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á</h6>
                                <p class="mb-1"><strong>‡∏´‡πâ‡∏≠‡∏á:</strong> ${room.roomName}</p>
                                <p class="mb-1"><strong>‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤:</strong> ${room.tenantName}</p>
                                <p class="mb-0"><strong>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ:</strong> ‡∏ø${room.totalAmount.toLocaleString()}</p>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="bi bi-credit-card me-2"></i>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</h6>
                                <div class="progress mb-2">
                                    <div class="progress-bar ${room.paymentProgress >= 100 ? 'bg-success' : room.paymentProgress >= 50 ? 'bg-warning' : 'bg-danger'}" 
                                         style="width: ${room.paymentProgress}%">${room.paymentProgress}%</div>
                                </div>
                                <p class="mb-0">
                                    <span class="badge ${room.isFullyPaid ? 'bg-success' : room.isPartiallyPaid ? 'bg-warning' : 'bg-danger'}">
                                        ${room.isFullyPaid ? '‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏£‡∏ö' : room.isPartiallyPaid ? '‡∏à‡πà‡∏≤‡∏¢‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢'}
                                    </span>
                                </p>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-4 text-center">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <h6 class="card-title">‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á</h6>
                                        <h5 class="text-primary">‡∏ø${room.roomCharge.amount.toLocaleString()}</h5>
                                        <span class="badge ${room.roomCharge.isPaid ? 'bg-success' : 'bg-danger'}">
                                            ${room.roomCharge.isPaid ? '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 text-center">
                                <div class="card border-info">
                                    <div class="card-body">
                                        <h6 class="card-title">‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥</h6>
                                        <h5 class="text-info">‡∏ø${room.waterBill.amount.toLocaleString()}</h5>
                                        <small class="text-muted">${room.waterBill.units} ‡∏´‡∏ô‡πà‡∏ß‡∏¢</small><br>
                                        <span class="badge ${room.waterBill.isPaid ? 'bg-success' : 'bg-danger'}">
                                            ${room.waterBill.isPaid ? '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 text-center">
                                <div class="card border-warning">
                                    <div class="card-body">
                                        <h6 class="card-title">‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü</h6>
                                        <h5 class="text-warning">‡∏ø${room.electricBill.amount.toLocaleString()}</h5>
                                        <small class="text-muted">${room.electricBill.units} ‡∏´‡∏ô‡πà‡∏ß‡∏¢</small><br>
                                        <span class="badge ${room.electricBill.isPaid ? 'bg-success' : 'bg-danger'}">
                                            ${room.electricBill.isPaid ? '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    $('#roomDetailContent').html(detailHtml);
                    $('#roomDetailModalLabel').text(`‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡πâ‡∏≠‡∏á ${room.roomName}`);
                    $('#roomDetailModal').modal('show');
                } else {
                    showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏î‡πâ');
                }
            }).fail(() => showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'));
        };

        window.showPaymentHistory = function(roomId) {
            $.get('/Finance/GetPaymentHistory', { roomId: roomId, months: 6 }, function(response) {
                if (response.success) {
                    let historyHtml = '<div class="row">';
                    
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á
                    historyHtml += '<div class="col-md-4"><h6>‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á</h6><div class="list-group">';
                    response.roomCharges.forEach(charge => {
                        historyHtml += `
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${charge.month}</strong><br>
                                    <small>‡∏ø${charge.amount.toLocaleString()}</small>
                                </div>
                                <span class="badge ${charge.isPaid ? 'bg-success' : 'bg-danger'}">
                                    ${charge.isPaid ? '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢'}
                                </span>
                            </div>
                        `;
                    });
                    historyHtml += '</div></div>';

                    // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥
                    historyHtml += '<div class="col-md-4"><h6>‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥</h6><div class="list-group">';
                    response.waterBills.forEach(bill => {
                        historyHtml += `
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${bill.month}</strong><br>
                                    <small>‡∏ø${bill.amount.toLocaleString()} (${bill.units} ‡∏´‡∏ô‡πà‡∏ß‡∏¢)</small>
                                </div>
                                <span class="badge ${bill.isPaid ? 'bg-success' : 'bg-danger'}">
                                    ${bill.isPaid ? '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢'}
                                </span>
                            </div>
                        `;
                    });
                    historyHtml += '</div></div>';

                    // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü
                    historyHtml += '<div class="col-md-4"><h6>‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü</h6><div class="list-group">';
                    response.electricBills.forEach(bill => {
                        historyHtml += `
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${bill.month}</strong><br>
                                    <small>‡∏ø${bill.amount.toLocaleString()} (${bill.units} ‡∏´‡∏ô‡πà‡∏ß‡∏¢)</small>
                                </div>
                                <span class="badge ${bill.isPaid ? 'bg-success' : 'bg-danger'}">
                                    ${bill.isPaid ? '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢'}
                                </span>
                            </div>
                        `;
                    });
                    historyHtml += '</div></div></div>';

                    Swal.fire({
                        title: '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô',
                        html: historyHtml,
                        width: '900px',
                        showCloseButton: true,
                        focusConfirm: false,
                        confirmButtonText: '‡∏õ‡∏¥‡∏î'
                    });
                } else {
                    showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ');
                }
            }).fail(() => showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥'));
        };

        window.printRoomReceipt = function(roomId) {
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
            window.open('/Finance/GenerateRoomReceipt?roomId=' + roomId, '_blank');
        };

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü
        window.addWaterBill = function(roomId, roomName) {
            $('#water_bill_id').val('');
            $('#water_room_id').val(roomId);
            $('#water_room_name').val(roomName);
            $('#water_people_count').val(1);
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ water_units ‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö people_count
            calculateWaterBillByPeople();
            $('#water_bill_notes').val('');
            $('#waterBillModalLabel').text('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥ - ' + roomName);
            $('#waterBillModal').modal('show');
        };

        window.editWaterBill = function(roomId, roomName) {
            const room = missionData.find(r => r.roomId === roomId);
            if (room && room.waterBill.amount > 0) {
                $('#water_bill_id').val(room.waterBill.id || '');
                $('#water_room_id').val(roomId);
                $('#water_room_name').val(roomName);
                $('#water_people_count').val(room.waterBill.units || 1);
                $('#water_bill_amount').val(room.waterBill.amount);
                $('#water_bill_notes').val('');
                $('#waterBillModalLabel').text('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥ - ' + roomName);
                $('#waterBillModal').modal('show');
            }
        };

        window.addElectricBill = function(roomId, roomName) {
            $('#electric_bill_id').val('');
            $('#electric_room_id').val(roomId);
            $('#electric_room_name').val(roomName);
            $('#electric_old_meter').val('');
            $('#electric_new_meter').val('');
            $('#electric_units').val(0);
            $('#electric_bill_amount').val(0);
            $('#electric_bill_notes').val('');
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
            const now = moment().format('YYYY-MM-DD');
            $('#meter_date').val(now);
            $('#electricBillModalLabel').text('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü - ' + roomName);
            $('#electricBillModal').modal('show');
        };

        window.editElectricBill = function(roomId, roomName) {
            const room = missionData.find(r => r.roomId === roomId);
            if (room && room.electricBill.amount > 0) {
                $('#electric_bill_id').val(room.electricBill.id || '');
                $('#electric_room_id').val(roomId);
                $('#electric_room_name').val(roomName);
                $('#electric_old_meter').val(0);
                $('#electric_new_meter').val(room.electricBill.units || 0);
                $('#electric_units').val(room.electricBill.units || 0);
                $('#electric_bill_amount').val(room.electricBill.amount);
                $('#electric_bill_notes').val('');
                $('#electricBillModalLabel').text('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü - ' + roomName);
                $('#electricBillModal').modal('show');
            }
        };

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô
        function calculateWaterBillByPeople() {
            const peopleCount = parseInt($('#water_people_count').val()) || 0;
            const waterRate = rates.waterRate || 150; // ‡πÉ‡∏ä‡πâ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏à‡∏≤‡∏Å settings ‡∏´‡∏£‡∏∑‡∏≠ 150 ‡∏ö‡∏≤‡∏ó/‡∏Ñ‡∏ô
            const totalBill = peopleCount * waterRate;
            $('#water_bill_amount').val(totalBill);
            $('#water_units').val(peopleCount); // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ water_units ‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô
        }

        // Event handlers ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏´‡∏°‡πà
        $('#water_people_count').on('input', calculateWaterBillByPeople);
        $('#electric_old_meter, #electric_new_meter').on('input', calculateElectricBill);

        // ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥
        $('#waterBillForm').on('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const billId = $('#water_bill_id').val();
            const isEdit = billId && billId.trim() !== '';
            
            const url = isEdit ? `/Finance/UpdateWaterBill/${billId}` : '/Finance/CreateWaterBill';
            
            $.ajax({
                url: url,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false, 
                success: function (response) {
                    if (response.success) {
                        $('#waterBillModal').modal('hide');
                        safeRefreshData(); // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô safeRefreshData ‡πÅ‡∏ó‡∏ô refreshAllData
                        showSuccess(isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                    } else {
                        showError(response.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
                    }
                },
                error: function () {
                    showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                }
            });
        });

        // ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü
        $('#electricBillForm').on('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const billId = $('#electric_bill_id').val();
            const isEdit = billId && billId.trim() !== '';
            
            const url = isEdit ? `/Finance/UpdateElectricMeter/${billId}` : '/Finance/CreateElectricMeter';
            
            $.ajax({
                url: url,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    if (response.success) {
                        $('#electricBillModal').modal('hide');
                        safeRefreshData(); // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô safeRefreshData ‡πÅ‡∏ó‡∏ô refreshAllData
                        showSuccess(isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                    } else {
                        showError(response.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
                    }
                },
                error: function () {
                    showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                }
            });
        });

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Detail Tables
        window.editWaterMeter = function(id) {
            $.get('/Finance/GetWaterMeters', function(response) {
                const waterMeter = response.data.find(w => w.water_meter_id === id);
                if (waterMeter) {
                    $('#water_meter_id').val(waterMeter.water_meter_id);
                    $('#room_id').val(waterMeter.room_id);
                    $('#meter_date').val(waterMeter.meter_date);
                    $('#old_meter').val(waterMeter.old_meter);
                    $('#new_meter').val(waterMeter.new_meter);
                    $('#water_units').val(waterMeter.water_units);
                    $('#water_bill').val(waterMeter.water_bill);
                    $('#water_notes').val(waterMeter.notes);
                    
                    $('#waterMeterModalLabel').text('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥');
                    $('#waterMeterModal').modal('show');
                }
            });
        };

        window.editElectricMeter = function(id) {
            $.get('/Finance/GetElectricMeters', function(response) {
                const electricMeter = response.data.find(e => e.electric_meter_id === id);
                if (electricMeter) {
                    $('#electric_meter_id').val(electricMeter.electric_meter_id);
                    $('#electric_room_id').val(electricMeter.room_id);
                    $('#electric_meter_date').val(electricMeter.meter_date);
                    $('#electric_old_meter').val(electricMeter.old_meter);
                    $('#electric_new_meter').val(electricMeter.new_meter);
                    $('#electric_units').val(electricMeter.electric_units);
                    $('#electric_bill').val(electricMeter.electric_bill);
                    $('#electric_notes').val(electricMeter.notes);
                    
                    $('#electricMeterModalLabel').text('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü');
                    $('#electricMeterModal').modal('show');
                }
            });
        };

        window.editRoomCharge = function(roomId, roomName, chargeId) {
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å missionData
            const room = missionData.find(r => r.roomId === roomId);
            if (!room || !room.roomCharge) {
                showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á');
                return;
            }

            $('#room_charge_id').val(chargeId);
            $('#room_charge_room_id').val(roomId);
            // ‡πÉ‡∏ä‡πâ readonly ‡πÅ‡∏ó‡∏ô disabled ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ‡∏Å‡∏±‡∏ö form ‡πÑ‡∏î‡πâ
            $('#room_charge_room_id').prop('readonly', true);
            $('#room_charge_room_id').css('background-color', '#e9ecef');
            
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡∏à‡∏≤‡∏Å API
            $.get(`/Finance/GetRoomChargeDetail/${chargeId}`, function(response) {
                if (response.success && response.data) {
                    const data = response.data;
                    
                    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
                    if (data.charge_month) {
                        $('#charge_month').val(moment(data.charge_month).format('YYYY-MM'));
                    }
                    
                    if (data.due_date) {
                        $('#due_date').val(moment(data.due_date).format('YYYY-MM-DD'));
                    }
                    
                    $('#room_price').val(data.room_price || room.roomCharge.amount);
                    $('#room_charge_notes').val(data.notes || '');
                    
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API ‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å missionData ‡πÅ‡∏ó‡∏ô
                    $('#charge_month').val(moment().format('YYYY-MM'));
                    $('#due_date').val(moment().add(1, 'months').date(5).format('YYYY-MM-DD'));
                    $('#room_price').val(room.roomCharge.amount);
                    $('#room_charge_notes').val('');
                }
                
                $('#roomChargeModalLabel').text('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á - ' + roomName);
                $('#roomChargeModal').modal('show');
            }).fail(function() {
                // ‡∏ñ‡πâ‡∏≤ API ‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å missionData ‡πÅ‡∏ó‡∏ô
                $('#charge_month').val(moment().format('YYYY-MM'));
                $('#due_date').val(moment().add(1, 'months').date(5).format('YYYY-MM-DD'));
                $('#room_price').val(room.roomCharge.amount);
                $('#room_charge_notes').val('');
                
                $('#roomChargeModalLabel').text('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á - ' + roomName);
                $('#roomChargeModal').modal('show');
            });
        };

        window.deleteWaterMeter = function(id) {
            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
                text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: `/Finance/DeleteWaterMeter/${id}`,
                        type: 'DELETE',
                        success: function(response) {
                            if (response.success) {
                                refreshDetailTables();
                                showSuccess('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                            } else {
                                showError(response.message);
                            }
                        },
                        error: function() {
                            showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
                        }
                    });
                }
            });
        };

        window.deleteElectricMeter = function(id) {
            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
                text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: `/Finance/DeleteElectricMeter/${id}`,
                        type: 'DELETE',
                        success: function(response) {
                            if (response.success) {
                                refreshDetailTables();
                                showSuccess('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                            } else {
                                showError(response.message);
                            }
                        },
                        error: function() {
                            showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
                        }
                    });
                }
            });
        };

        window.deleteRoomCharge = function(id) {
            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
                text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: `/Finance/DeleteRoomCharge/${id}`,
                        type: 'DELETE',
                        success: function(response) {
                            if (response.success) {
                                refreshDetailTables();
                                showSuccess('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                            } else {
                                showError(response.message);
                            }
                        },
                        error: function() {
                            showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
                        }
                    });
                }
            });
        };

        // ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î modal
        $('.modal').on('hidden.bs.modal', function () {
            const form = $(this).find('form')[0];
            if (form) {
                form.reset();
            }
            $(this).find('input[type="hidden"]').val('');
            
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï modal title ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            if ($(this).attr('id') === 'waterMeterModal') {
                $('#waterMeterModalLabel').text('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥');
            } else if ($(this).attr('id') === 'electricMeterModal') {
                $('#electricMeterModalLabel').text('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü');
            } else if ($(this).attr('id') === 'roomChargeModal') {
                $('#roomChargeModalLabel').text('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á');
                // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                $('#room_charge_room_id').prop('readonly', false);
                $('#room_charge_room_id').css('background-color', '');
            }
        });

        // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£ submit ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ã‡πâ‡∏≥
        $('form').on('submit', function() {
            const submitBtn = $(this).find('button[type="submit"]');
            submitBtn.prop('disabled', true);
            setTimeout(() => {
                submitBtn.prop('disabled', false);
            }, 3000);
        });

        function setupEventListeners() {
            // ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            $('#selectAllRooms').on('change', function () {
                const isChecked = $(this).prop('checked');
                $('.room-checkbox').prop('checked', isChecked);
                updateSelectedRooms();
            });

            // ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡πâ‡∏≠‡∏á
            $(document).on('change', '.room-checkbox', function () {
                updateSelectedRooms();
            });

            // ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            $('.filter-option').on('click', function (e) {
                e.preventDefault();
                currentFilter = $(this).data('filter');
                applyFilter();
            });

            // ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≤‡∏á‡πÜ
            $('#refreshDataBtn').on('click', safeRefreshData);
            $('#createMissionBtn').on('click', createMission);
            $('#generateMonthlyChargesBtn').on('click', generateMonthlyCharges);
            $('#markAllPaidBtn').on('click', markAllAsPaid);
            $('#printMissionBtn').on('click', printMission);
            $('#overdueReportBtn').on('click', showOverdueReport);
            $('#bulkCollectBtn').on('click', bulkCollectPayment);
            $('#exportMissionBtn').on('click', exportMissionData);

            // ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    $('#roomChargeForm').on('submit', handleRoomChargeSubmit);

        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        $('#room_charge_room_id').on('change', function() {
            const roomId = $(this).val();
            if (roomId) {
                // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏ô ViewBag ‡∏´‡∏£‡∏∑‡∏≠ missionData
                const viewBagRooms = @Html.Raw(Json.Serialize(ViewBag.Rooms ?? new object[0]));
                const selectedRoom = viewBagRooms.find(r => r.room_id == roomId);
                
                if (selectedRoom && selectedRoom.room_price) {
                    $('#room_price').val(selectedRoom.room_price);
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å API
                    $.get('/Rooms/GetRoomDetails', { roomId: roomId }, function(response) {
                        if (response.success && response.data && response.data.room_price) {
                            $('#room_price').val(response.data.room_price);
                        }
                    });
                }
            }
        });

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        $('#electric_old_meter, #electric_new_meter').on('input', calculateElectricBill);

            // ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            $('#autoRefresh').on('change', function () {
                if ($(this).is(':checked')) {
                    startAutoRefresh();
                } else {
                    stopAutoRefresh();
                }
            });

            // ‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏£‡∏ö
            $('#hideCompletedRooms').on('change', function () {
                applyFilter();
            });
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        function loadRoomOptions() {
            // ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å ViewBag ‡∏Å‡πà‡∏≠‡∏ô
            const viewBagRooms = @Html.Raw(Json.Serialize(ViewBag.Rooms ?? new object[0]));
            if (viewBagRooms && viewBagRooms.length > 0) {
                const options = viewBagRooms.map(room => 
                    `<option value="${room.room_id}">${room.room_name} (‡∏ø${room.room_price ? room.room_price.toLocaleString() : '0'})</option>`
                ).join('');
                
                $('#room_charge_room_id').html(
                    '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option>' + options
                );
            } else {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å ViewBag ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å API
                $.get('/Rooms/GetAvailableRooms', function (response) {
                    let rooms = [];
                    if (response.success && response.data) {
                        rooms = response.data;
                    } else if (response.length) {
                        rooms = response; // ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà API ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
                    }
                    
                    if (rooms.length > 0) {
                        const options = rooms.map(room => 
                            `<option value="${room.room_id}">${room.room_name} (‡∏ø${room.room_price ? room.room_price.toLocaleString() : '0'})</option>`
                        ).join('');
                        
                        $('#room_charge_room_id').html(
                            '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option>' + options
                        );
                    }
                }).fail(function() {
                    console.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ');
                });
            }
        }

        function loadRates() {
            $.get('/Finance/GetRates', function (data) {
                rates = data;
                $('#waterRateDisplay').text(data.waterRate || 150);
                $('#electricRateDisplay').text(data.electricRate);
            });
        }

        function updateStatistics() {
            console.log('‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥...');
            
            $.ajax({
                url: '/Finance/GetStatistics',
                type: 'GET',
                timeout: 15000, // 15 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                success: function (data) {
                    console.log('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥:', data);
                    
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
                    $('#totalIncome').text('‡∏ø' + (data.totalIncome || 0).toLocaleString());
                    $('#totalCollected').text('‡∏ø' + (data.totalCollected || 0).toLocaleString());
                    $('#totalPending').text('‡∏ø' + (data.totalPending || 0).toLocaleString());
                    $('#pendingRoomsCount').text(data.pendingRooms || 0);

                    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå
                    const collectionRate = data.analytics?.collectionRate || 0;
                    const totalIncome = data.totalIncome || 0;
                    const totalCollected = data.totalCollected || 0;
                    const collectedPct = totalIncome > 0 ? Math.round((totalCollected / totalIncome) * 100) : 0;
                    const pendingPct = 100 - collectedPct;

                    $('#collectionRate').text(collectionRate + '%');
                    $('#collectedPercentage').text(collectedPct + '% ‡∏Ç‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°');
                    $('#pendingPercentage').text(pendingPct + '% ‡∏Ç‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°');
                    
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ñ‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤
                    $('#collectionProgress').css('width', collectionRate + '%').attr('aria-valuenow', collectionRate);

                    // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï
                    if (data.analytics?.growthRate !== undefined) {
                        const growthRate = data.analytics.growthRate;
                        const growthClass = growthRate >= 0 ? 'text-success' : 'text-danger';
                        const growthIcon = growthRate >= 0 ? 'üìà' : 'üìâ';
                        $('#incomeGrowth').html(`${growthIcon} ${growthRate}%`).removeClass('text-success text-danger').addClass(growthClass);
                    }

                    // ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á
                    if (data.analytics?.averagePerRoom) {
                        $('#averageAmount').text(`‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ‡∏ø${data.analytics.averagePerRoom.toLocaleString()}/‡∏´‡πâ‡∏≠‡∏á`);
                    }
                    
                    console.log('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');
                },
                error: function (xhr, status, error) {
                    console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥:', { xhr, status, error });
                    
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
                    $('#totalIncome').text('‡∏ø0');
                    $('#totalCollected').text('‡∏ø0');
                    $('#totalPending').text('‡∏ø0');
                    $('#pendingRoomsCount').text('0');
                    $('#collectionRate').text('0%');
                    $('#collectedPercentage').text('0% ‡∏Ç‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°');
                    $('#pendingPercentage').text('0% ‡∏Ç‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°');
                    $('#collectionProgress').css('width', '0%').attr('aria-valuenow', 0);
                    $('#averageAmount').text('‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ‡∏ø0/‡∏´‡πâ‡∏≠‡∏á');
                    
                    if (status !== 'abort') { // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á error ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                        console.warn('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÑ‡∏î‡πâ ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô');
                    }
                }
            });
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤
        window.manageTenant = function(roomId, roomName) {
            $('#tenant_room_id').val(roomId);
            $('#tenantModalLabel').text('‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤ - ‡∏´‡πâ‡∏≠‡∏á ' + roomName);
            
            // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤
            $('#tenant_select').val('');
            $('#tenant_start_date').val('');
            $('#tenant_end_date').val('');
            
            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            loadCurrentTenant(roomId);
            
            // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
            loadAvailableUsers();
            
            // ‡πÅ‡∏™‡∏î‡∏á modal
            $('#tenantModal').modal('show');
        };

        function loadCurrentTenant(roomId) {
            $.get('/Rooms/GetRoomTenant', { roomId: roomId }, function(response) {
                if (response.success) {
                    if (response.hasTenant) {
                        // ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤
                        $('#current_tenant_name').text(response.tenant.fullname || '-');
                        $('#current_tenant_email').text(response.tenant.email || '-');
                        $('#current_tenant_phone').text(response.tenant.phone || '-');
                        $('#current_tenant_start_date').text(response.tenant.start_date || '-');
                        $('#current_tenant_end_date').text(response.tenant.end_date || '-');
                        
                        $('#no_tenant_alert').hide();
                        $('#tenant_details').show();
                    } else {
                        // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤
                        $('#no_tenant_alert').show();
                        $('#tenant_details').hide();
                    }
                } else {
                    showError(response.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤‡πÑ‡∏î‡πâ');
                }
            }).fail(function() {
                showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤');
            });
        }

        function loadAvailableUsers() {
            $.get('/Rooms/GetAvailableUsers', function(response) {
                if (response.success && response.users) {
                    const selectElement = $('#tenant_select');
                    selectElement.html('<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤ --</option>');
                    
                    response.users.forEach(function(user) {
                        selectElement.append(`<option value="${user.id}">${user.fullname || user.email || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ' + user.id}</option>`);
                    });
                } else {
                    showError(response.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ');
                }
            }).fail(function() {
                showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
            });
        }

        $('#save_tenant_btn').on('click', function() {
            const roomId = parseInt($('#tenant_room_id').val());
            const userId = parseInt($('#tenant_select').val());
            const startDate = $('#tenant_start_date').val();
            const endDate = $('#tenant_end_date').val();
            
            if (!roomId) {
                showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á');
                return;
            }
            
            if (!userId) {
                showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤');
                return;
            }
            
            $.ajax({
                url: '/Rooms/UpdateRoomTenant',
                type: 'POST',
                data: {
                    roomId: roomId,
                    userId: userId,
                    startDate: startDate || null,
                    endDate: endDate || null
                },
                success: function(response) {
                    if (response.success) {
                        $('#tenantModal').modal('hide');
                        showSuccess(response.message || '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                        
                        // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Mission ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        safeRefreshData(); // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô safeRefreshData ‡πÅ‡∏ó‡∏ô refreshAllData
                    } else {
                        showError(response.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤‡πÑ‡∏î‡πâ');
                    }
                },
                error: function() {
                    showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤');
                }
            });
        });

        $('#remove_tenant_btn').on('click', function() {
            const roomId = parseInt($('#tenant_room_id').val());
            
            if (!roomId) {
                showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á');
                return;
            }
            
            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤',
                text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/Rooms/RemoveRoomTenant',
                        type: 'POST',
                        data: { roomId: roomId },
                                        success: function(response) {
                    if (response.success) {
                        $('#tenantModal').modal('hide');
                        showSuccess(response.message || '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                        
                        // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Mission ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        safeRefreshData(); // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô safeRefreshData ‡πÅ‡∏ó‡∏ô refreshAllData
                    } else {
                        showError(response.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤‡πÑ‡∏î‡πâ');
                    }
                },
                        error: function() {
                            showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤');
                        }
                    });
                }
            });
        });

        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î modal
        $('#tenantModal').on('shown.bs.modal', function() {
            const today = moment().format('YYYY-MM-DD');
            const oneYearLater = moment().add(1, 'year').format('YYYY-MM-DD');
            
            if (!$('#tenant_start_date').val()) {
                $('#tenant_start_date').val(today);
            }
            
            if (!$('#tenant_end_date').val()) {
                $('#tenant_end_date').val(oneYearLater);
            }
        });

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á)
        function manualCreateRoomCharge(roomId, roomName) {
            $('#room_charge_id').val('');
            $('#room_charge_room_id').val(roomId);
            // ‡πÉ‡∏ä‡πâ readonly ‡πÅ‡∏ó‡∏ô disabled ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ‡∏Å‡∏±‡∏ö form ‡πÑ‡∏î‡πâ
            $('#room_charge_room_id').prop('readonly', true);
            $('#room_charge_room_id').css('background-color', '#e9ecef');
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            $('#charge_month').val(moment().format('YYYY-MM'));
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 5 ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ)
            $('#due_date').val(moment().add(1, 'months').date(5).format('YYYY-MM-DD'));
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            const room = missionData.find(r => r.roomId === roomId);
            if (room && room.defaultPrice) {
                $('#room_price').val(room.defaultPrice);
            } else {
                $('#room_price').val('');
            }
            
            $('#room_charge_notes').val('');
            $('#roomChargeModalLabel').text('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á - ' + roomName);
            $('#roomChargeModal').modal('show');
        }
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ
        window.checkAndSetupRoomCharge = function(roomId, roomName) {
            const room = missionData.find(r => r.roomId === roomId);
            
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô 0
            if (!room || !room.roomCharge || room.roomCharge.amount <= 0) {
                Swal.fire({
                    title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á',
                    text: `‡∏´‡πâ‡∏≠‡∏á ${roomName} ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á',
                    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
                }).then((result) => {
                    if (result.isConfirmed) {
                        manualCreateRoomCharge(roomId, roomName);
                    }
                });
            } else {
                // ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                showRoomDetail(roomId);
            }
        };
    </script>
}